"""Validate and submit predictions to Kaggle's Smadex competition."""
from __future__ import annotations

import argparse
import subprocess
from pathlib import Path

import pandas as pd


def _parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description="Submit LTV predictions to Kaggle")
    parser.add_argument(
        "--file",
        default="data/submissions/submission.csv",
        help="Path to the submission CSV generated by scripts/predict.py"
    )
    parser.add_argument(
        "--sample",
        default="data/raw/sample_submission.csv",
        help="Reference sample submission used to validate schema and ordering"
    )
    parser.add_argument(
        "--competition",
        default="smadex-challenge-predict-the-revenue",
        help="Kaggle competition slug"
    )
    parser.add_argument(
        "--message",
        default="Auto submission",
        help="Submission description shown on Kaggle"
    )
    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="Validate files and show the Kaggle CLI command without executing it"
    )
    parser.add_argument(
        "--align-order",
        action="store_true",
        help="Align submission row order to match the sample before validation"
    )
    return parser.parse_args()


def _load_csv(path: Path, context: str) -> pd.DataFrame:
    if not path.exists():
        raise FileNotFoundError(f"{context} file not found: {path}")
    df = pd.read_csv(path)
    if df.empty:
        raise ValueError(f"{context} file is empty: {path}")
    return df


def _validate_submission(
    submission: pd.DataFrame,
    sample: pd.DataFrame,
    align_order: bool
) -> tuple[pd.DataFrame, dict[str, float]]:
    required_columns = sample.columns.tolist()
    if submission.columns.tolist() != required_columns:
        raise ValueError(
            "Submission columns mismatch sample. Expected %s but received %s" %
            (required_columns, submission.columns.tolist())
        )

    if align_order and not submission['row_id'].equals(sample['row_id']):
        submission = (
            submission.set_index('row_id')
            .reindex(sample['row_id'])
            .reset_index()
        )

    if len(submission) != len(sample):
        raise ValueError(
            f"Submission row count ({len(submission)}) does not match sample ({len(sample)})"
        )

    if not submission['row_id'].equals(sample['row_id']):
        raise ValueError(
            "Row ordering mismatch. Use --align-order to realign automatically."
        )

    stats = {
        'rows': float(len(submission)),
        'mean': float(submission['iap_revenue_d7'].mean()),
        'median': float(submission['iap_revenue_d7'].median()),
        'std': float(submission['iap_revenue_d7'].std()),
        'zeros_pct': float((submission['iap_revenue_d7'] == 0).mean() * 100.0)
    }
    return submission, stats


def _run_kaggle_cli(
    competition: str,
    file_path: Path,
    message: str,
    dry_run: bool
) -> None:
    command = [
        "kaggle",
        "competitions",
        "submit",
        "-c",
        competition,
        "-f",
        str(file_path),
        "-m",
        message
    ]

    print("\nKaggle CLI command:")
    print(' '.join(command))

    if dry_run:
        print("\nDry run enabled âžœ skipped executing Kaggle CLI. Run again without --dry-run to submit.")
        return

    subprocess.run(command, check=True)


def main() -> None:
    args = _parse_args()

    submission_path = Path(args.file)
    sample_path = Path(args.sample)

    submission_df = _load_csv(submission_path, "Submission")
    sample_df = _load_csv(sample_path, "Sample")

    submission_df, stats = _validate_submission(
        submission_df,
        sample_df,
        align_order=args.align_order
    )

    # Overwrite file if ordering was aligned
    if args.align_order:
        submission_df.to_csv(submission_path, index=False)

    print("Submission validated successfully:")
    print(f"  Rows: {int(stats['rows'])}")
    print(f"  Mean: {stats['mean']:.4f}")
    print(f"  Median: {stats['median']:.4f}")
    print(f"  Std: {stats['std']:.4f}")
    print(f"  % Zeros: {stats['zeros_pct']:.2f}%")

    _run_kaggle_cli(
        args.competition,
        submission_path,
        args.message,
        dry_run=args.dry_run
    )
if __name__ == "__main__":
    main()

